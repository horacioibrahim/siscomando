<!-- polymer project components -->
<!-- <link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html"> -->
<!-- <link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html"> -->
<!-- for this components 
<link rel="import" href="../app-bar/app-bar.html"> -->
<!-- layout 
<link rel="import" href="../layouts/drawer-panel-layout.html">
-->
<dom-module id="page-feeds">
  <template>
    <style>
      :host {
        
        
      }
      paper-toolbar {
        --paper-toolbar-background: #135FB8;
        color: white;
      }

      .container-feeds { /* the default is mobile */
        /* @apply(--layout-vertical);  commnet due Safari not applying height 100% */
        /*width: 100%;
        height: 100%;*/
      }
      paper-toolbar  .title {
            margin-left: 30px;
        }
      .container-feeds .rowOne, div.rowOne {
        positon: absolute;
        height: 100%;
        overflow-y: scroll;
        padding-left: 5px;
        padding-right: 30px;
        padding-top: 10px;
        padding-bottom: 90px;
        
      }  
      .container-feeds .rowTwo {
        position: fixed;
        bottom: 0;
        width: 100%;
      }
      paper-textarea#inputLikeZap {
          --paper-input-container: {
            background-color: rgba(255,255,255,0.8);
            padding-left: 10px;
            padding-right: 6px;
            border-top: 1px solid rgba(0,0,0,.10);
          }
      }  
      sc-form {
            background-color: rgba(255,255,255,0.8);
            /* padding-left: 10px;*/
            padding-right: 6px;
            border-top: 1px solid rgba(0,0,0,.10);          
      }
      paper-input.short {
        width: 100%;
       }        
      .bottomInput {
        position: absolute;
        float: left;
        background: #F5F8F8;
        width: 100%;
        bottom: 0;
      }        
      /** Media Queries **/
      @media (min-width: 768px) and (orientation: landscape) {
        .container-feeds {
            @apply(--layout-vertical);
            width: 100%;
            height: 100%;
            overflow-y: scroll;
        }
        .container-feeds .rowOne, div.rowOne {
          positon: absolute;
          height: 100%;
          width: 100%;
          overflow-y: scroll; 
          padding-top: 10px;
          padding-left: 5px;
          padding-right: 40px;
          padding-bottom: 100px;
        }
      }        
    </style>
    <drawer-panel-layout>
          <!-- drawer is hide -->
        
          <!-- main is content -->
          <paper-header-panel class="main">
            <!-- header -->
            <paper-toolbar>
              <iron-icon icon="chevron-left" on-tap="_historyBack"></iron-icon>
              <div class="title">{{title}}</div>
              <app-bar class="horizontal layout center end-justified" no-search></app-bar>
            </paper-toolbar>
            <!-- content -->
            <div class="container-feeds fit">
                <div class="rowOne">
                    <sc-feeds id="feeds"></sc-feeds>
                </div>
                <div class="rowTwo">
                    <!-- Esse input eh autonomo e não faz parte especificamente dos feeds.
                    Ele poderia ter uma propriedade p/ ficar oculto quando o usuário não tiver
                    permissão para editar determinado feeds. (Não implementado).
                    -->
                    <div class="bottomInput">
                        <sc-form id="form"></sc-form>
                        <sc-keys id="keys"></sc-keys>
                    </div>
                </div> 
            </div>                 
          </paper-header-panel>

     
    </drawer-panel-layout>

  </template>
  <script>
    Polymer({
      is: 'page-feeds',
      properties: {
          title: {
              type: String,
              value: 'Feeds'
          },
          hashtag: {
              type: String,
              observer: 'hashtagChanged'
          },
          urlPost: {
              type: String,
              value: siscomando.url.feeds // Nas paginas eh local das configurações especificas da app. 
          }
      },
      // lifecyle....
      ready: function() {
          var self = this;
          var keys = this.$.keys;
          var form = this.$.form;
          var feeds = this.$.feeds;
          form.url = this.urlPost;
          // keys.keyEventTarget = this.$.form;
          keys.callback = function(keyPressed) {
              // if sc-keys has pressed (keyPressed) equal 'enter' so go().
              if (keyPressed === 'enter') {                
                  self.$.form.body = self.setBody();
                  // Header authorization: Basic TOKEN is already attached
                  self.$.form.go();
                  self.$.form.$.request.addEventListener('sc-request-response', self._updateAfterPOST);
              }
          };
      },
      // Custom behavior. //
        
      /** `setBody` sets the fields app's schema.*/
      setBody: function() {
        var body = {};
        var currentUser = JSON.parse(sessionStorage.getItem('currentUser'))
        // body['announcer'] = 'horacio.moreira'; // handler by JSON Token
        // to solve with body['timestamp'] = Date.now();
        body['body'] = this.$.form.bindValue;
        body['hashtag'] = this.hashtag; 
        
        return body
      },
      hashtagChanged: function() {          
          var hashtag = this.hashtag;
          this.title = hashtag;
          this.$.feeds.hashtag = hashtag;
      },
      _title: function (string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      },
      _historyBack: function() {
        history.back();
      },
      _updateAfterPOST: function(evt) {
          var feeds = document.querySelector('sc-feeds#feeds.page-feeds');
          var self = document.querySelector('page-feeds');
          var docs = feeds.documents.slice();
          docs.push(evt.detail.response);
          feeds.documents = docs.slice();
          feeds.playAnimation();
          this.async(self.scrollDown, 600);
      },
      /** `scrollDown` moves scroll to down making last update to be 
      * show.
      */
      scrollDown: function() {
          var element = document.querySelector('.rowOne');
          element.scrollTop = element.scrollHeight;        
      }        
    });
  </script>
</dom-module>
